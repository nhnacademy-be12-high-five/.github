name: Common Workflow (Reusable Docker Blue/Green Deploy)

on:
  workflow_call:
    inputs:
      service-name:
        required: true
        type: string
        description: "배포할 서비스의 이미지 이름 (예: book-server 또는 front_server)"
      deploy-path:
        required: true
        type: string
        description: "서버 내 프로젝트 경로 (예: /home/ubuntu/www/nhnbook)"

    secrets:
      DOCKER_USERNAME:
        required: true
      DOCKER_PASSWORD:
        required: true
      SSH_IP:
        required: true
      SSH_ID:
        required: true
      SSH_PW:
        required: true
      SSH_PORT:
        required: true

jobs:
  build-push-and-deploy:
    runs-on: ubuntu-latest
    steps:
      # 1. 코드 체크아웃
      - uses: actions/checkout@v4

      # 2. JDK 21 설정
      - name: Set up JDK 21
        uses: actions/setup-java@v4
        with:
          java-version: '21'
          distribution: 'temurin'
          cache: 'maven'

      # 3. Maven 빌드
      - name: Build with Maven
        run: mvn clean package -DskipTests

      # 4. 🗑️ 의존성 그래프 제출 단계 삭제 (주석 처리됨)

      # 5. Docker Hub 로그인
      - name: Log in to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      # 6. Docker 이미지 빌드 및 푸시
      - name: Build and push Docker image
        uses: docker/build-push-action@v5
        with:
          context: .
          push: true
          tags: ${{ secrets.DOCKER_USERNAME }}/${{ inputs.service-name }}:latest

      # 7. SSH 접속 및 Blue/Green 배포 스크립트 실행
      - name: Deploy to Server (Blue/Green)
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.SSH_IP }}
          username: ${{ secrets.SSH_ID }}
          password: ${{ secrets.SSH_PW }}
          port: ${{ secrets.SSH_PORT }}
          script: |
            DEPLOY_PATH="${{ inputs.deploy-path }}"
            SERVICE_NAME="${{ inputs.service-name }}"
            NGINX_CONF_PATH="/home/backend/be12-team5/nginx"
            
            echo "🚀 $SERVICE_NAME 배포를 시작합니다..."
            cd $DEPLOY_PATH
            
            # -------------------------------------------------------
            # 1. 서비스 타입(Front vs Backend)에 따라 포트와 설정 파일 결정 🌟
            # -------------------------------------------------------
            if [ "$SERVICE_NAME" == "front_server" ]; then
              echo "🎨 프론트엔드 배포 모드"
              BLUE_PORT="10483"
              GREEN_PORT="10484"
              UPSTREAM_CONF="$NGINX_CONF_PATH/conf.d/front_upstream.conf"
              HEALTH_PATH="" # (헬스체크 제거로 인해 사용 안 함)
            else
              echo "⚙️ 백엔드/게이트웨이 배포 모드"
              BLUE_PORT="10485" # Gateway Blue
              GREEN_PORT="10486" # Gateway Green
              UPSTREAM_CONF="$NGINX_CONF_PATH/conf.d/api_gateway_upstream.conf"
              HEALTH_PATH="/actuator/health" # (헬스체크 제거로 인해 사용 안 함)
            fi

            # -------------------------------------------------------
            # 2. 현재 활성 포트 확인 및 타겟 결정
            # -------------------------------------------------------
            # 파일이 없으면 기본값(Blue)으로 간주
            CURRENT_PORT=$(grep -o '[0-9]\{5\}' $UPSTREAM_CONF || echo "$BLUE_PORT")
            echo "🔎 현재 활성화된 포트: $CURRENT_PORT"
            
            # -------------------------------------------------------
            # 🚨 Old 환경 및 New 환경 설정
            # -------------------------------------------------------
            if [ "$CURRENT_PORT" == "$BLUE_PORT" ]; then
              # Blue가 현재 활성 (Old), Green이 배포 대상 (New)
              OLD_PORT=$BLUE_PORT
              OLD_COMPOSE_FILE="docker-compose-blue.yml"
              OLD_CONTAINER_NAME="team5-${SERVICE_NAME}-blue"

              TARGET_PORT=$GREEN_PORT
              TARGET_COMPOSE_FILE="docker-compose-green.yml"
              TARGET_CONTAINER_NAME="team5-${SERVICE_NAME}-green"

              echo "✅ 배포 대상: GREEN 환경 ($TARGET_PORT)"
            else
              # Green이 현재 활성 (Old), Blue가 배포 대상 (New)
              OLD_PORT=$GREEN_PORT
              OLD_COMPOSE_FILE="docker-compose-green.yml"
              OLD_CONTAINER_NAME="team5-${SERVICE_NAME}-green"

              TARGET_PORT=$BLUE_PORT
              TARGET_COMPOSE_FILE="docker-compose-blue.yml"
              TARGET_CONTAINER_NAME="team5-${SERVICE_NAME}-blue"
            
              echo "✅ 배포 대상: BLUE 환경 ($TARGET_PORT)"
            fi
            
            # -------------------------------------------------------
            # 3. 배포 실행 (특정 서비스만 UP)
            # -------------------------------------------------------
            echo "📥 최신 이미지를 다운로드(Pull) 중입니다..."
            docker-compose -f docker-compose-infra.yml -f $TARGET_COMPOSE_FILE pull $SERVICE_NAME
            
            echo "🔄 컨테이너를 시작합니다 ($SERVICE_NAME)..."
            # 🚨 TARGET 컨테이너 시작 (Old 컨테이너는 이 시점에서 아직 실행 중)
            docker-compose -f docker-compose-infra.yml -f $TARGET_COMPOSE_FILE up -d --no-deps $SERVICE_NAME
            
            # -------------------------------------------------------
            # 4. (제거됨) 헬스체크 (Health Check)
            # -------------------------------------------------------
            echo "⚠️ 헬스 체크 단계를 건너뛰고 즉시 트래픽을 전환합니다."

            # -------------------------------------------------------
            # 5. Nginx 트래픽 전환 (해당 upstream 파일만 수정) 및 Old 컨테이너 정리
            # -------------------------------------------------------
            echo "🔀 Nginx 설정을 변경합니다: $UPSTREAM_CONF -> $TARGET_PORT"
            
            # 해당 upstream 파일에만 포트 정보 덮어쓰기
            echo "server 127.0.0.1:$TARGET_PORT;" > $UPSTREAM_CONF
            
            # 5.1 Old 컨테이너 종료 및 제거
            echo "🗑️ 이전 컨테이너 ($OLD_CONTAINER_NAME)를 종료 및 제거합니다..."
            # docker-compose down 대신, 특정 컨테이너만 stop/rm 명령으로 정리합니다.
            docker stop $OLD_CONTAINER_NAME || true
            docker rm $OLD_CONTAINER_NAME || true

            # 6. 마무리
            echo "⏳ 설정 파일 업데이트 완료. 호스트 서버가 설정을 가져갈 때까지 대기합니다."
            docker image prune -f
            echo "✅ 배포 작업이 완료되었습니다."