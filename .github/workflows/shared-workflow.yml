name: Common Workflow (Reusable Docker Blue/Green Deploy)

on:
  workflow_call:
    inputs:
      service-name:
        required: true
        type: string
      # [ì°¸ê³ ] deploy-path ì…ë ¥ì€ ì´ ìŠ¤í¬ë¦½íŠ¸ì—ì„œ ì‚¬ìš©ë˜ì§€ ì•Šì•„ ì œê±° ê°€ëŠ¥í•©ë‹ˆë‹¤.
      # (ìŠ¤í¬ë¦½íŠ¸ ë‚´ë¶€ì— 'DEPLOY_PATH'ê°€ í•˜ë“œì½”ë”© ë˜ì–´ ìˆìŠµë‹ˆë‹¤.)
      deploy-path:
        required: true
        type: string

    secrets:
      DOCKER_USERNAME:
        required: true
      DOCKER_PASSWORD:
        required: true
      SSH_IP:
        required: true
      SSH_ID:
        required: true
      SSH_PW:
        required: true
      SSH_PORT:
        required: true

# [ìˆ˜ì • 1] 403 ì˜¤ë¥˜ë¥¼ í•´ê²°í•˜ê¸° ìœ„í•´ 'dependency-graph: write' ê¶Œí•œ ì¶”ê°€
permissions:
  contents: read
  dependency-graph: write

jobs:
  build-push-and-deploy:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up JDK 21
        uses: actions/setup-java@v4
        with:
          java-version: '21'
          distribution: 'temurin'
          cache: 'maven'

      - name: Build with Maven
        run: mvn clean package

      # [ì¶”ê°€] 403 ì˜¤ë¥˜ê°€ ë‚¬ë˜ ì˜ì¡´ì„± ê·¸ë˜í”„ ìŠ¤ìº”
      - name: Update dependency graph
        uses: advanced-security/maven-dependency-submission-action@v4

      - name: Log in to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      - name: Build and push Docker image
        uses: docker/build-push-action@v5
        with:
          context: .
          push: true
          tags: ${{ secrets.DOCKER_USERNAME }}/${{ inputs.service-name }}:latest

      - name: Deploy to EC2 via SSH (Blue/Green)
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.SSH_IP }}
          username: ${{ secrets.SSH_ID }}
          password: ${{ secrets.SSH_PW }}
          port: ${{ secrets.SSH_PORT }}
          script: |
            DEPLOY_PATH="~/www/nhnbook"
            NGINX_CONF_PATH="/home/backend/be12-team5/nginx"
            
            # --- ğŸ”µ API í¬íŠ¸ ì •ì˜ ---
            BLUE_API_PORT="10485"
            GREEN_API_PORT="10486"
            
            cd $DEPLOY_PATH
            
            # --- 1. í˜„ì¬ í™œì„± 'API' í¬íŠ¸ í™•ì¸ ---
            CURRENT_API_PORT=$(grep -o '[0-9]\{5\}' $NGINX_CONF_PATH/conf.d/api_gateway_upstream.conf)
            
            # --- 2. ë°°í¬í•  ëŒ€ìƒ(Idle) í™˜ê²½ ê²°ì • ---
            if [ "$CURRENT_API_PORT" == "$BLUE_API_PORT" ]; then
              echo "Current API is BLUE ($BLUE_API_PORT). Deploying to GREEN ($GREEN_API_PORT)..."
              TARGET_COMPOSE_FILE="docker-compose-green.yml"
              TARGET_API_PORT=$GREEN_API_PORT
            else
              echo "Current API is GREEN ($GREEN_API_PORT). Deploying to BLUE ($BLUE_API_PORT)..."
              TARGET_COMPOSE_FILE="docker-compose-blue.yml"
              # [ìˆ˜ì • 2] $BLUE_PORT -> $BLUE_API_PORT (ì¹˜ëª…ì ì¸ ì˜¤íƒ€ ìˆ˜ì •)
              TARGET_API_PORT=$BLUE_API_PORT
            fi
            
            # --- 3. ë¹„í™œì„±(Idle) í™˜ê²½ì— ìƒˆ ë²„ì „ ë°°í¬ ---
            # [ìˆ˜ì • 3] íŠ¹ì • ì„œë¹„ìŠ¤ë§Œ pull/up í•˜ëŠ” ê²ƒì´ ì•„ë‹ˆë¼,
            # Blue/Green ìŠ¤íƒ ì „ì²´ë¥¼ pull/up í•´ì•¼ í•©ë‹ˆë‹¤.
            # (Dockerê°€ ë³€ê²½ëœ ì´ë¯¸ì§€ë§Œ pull í•˜ë¯€ë¡œ íš¨ìœ¨ì ì…ë‹ˆë‹¤)
            echo "Pulling latest images for $TARGET_COMPOSE_FILE..."
            docker-compose -f docker-compose-infra.yml -f $TARGET_COMPOSE_FILE pull
            
            echo "Starting $TARGET_COMPOSE_FILE..."
            docker-compose -f docker-compose-infra.yml -f $TARGET_COMPOSE_FILE up -d --no-deps
            
            # --- 4. í—¬ìŠ¤ì²´í¬ (ë‹¨ìˆœ sleep ëŒ€ì‹  curlë¡œ ë³€ê²½) ---
            echo "Waiting for stack (Port: $TARGET_API_PORT) to be healthy..."
            HEALTHY=false
            # (actuator/health ì—”ë“œí¬ì¸íŠ¸ê°€ ìˆë‹¤ê³  ê°€ì •í•©ë‹ˆë‹¤)
            for i in {1..20}; do # 100ì´ˆê°„ (20íšŒ * 5ì´ˆ) ì‹œë„
              STATUS_CODE=$(curl -s -o /dev/null -w "%{http_code}" http://127.0.0.1:$TARGET_API_PORT/actuator/health)
            
              if [ "$STATUS_CODE" == "200" ]; then
                echo "Stack is healthy! (Status: $STATUS_CODE)"
                HEALTHY=true
                break
              fi
            
              echo "Attempt $i: Not yet healthy (Status: $STATUS_CODE). Retrying in 5 seconds..."
              sleep 5
            done

            if [ "$HEALTHY" != true ]; then
              echo "DEPLOYMENT FAILED: Stack did not become healthy in time."
              # (ì„ íƒ) ë¡¤ë°±ì´ í•„ìš”í•œ ê²½ìš° ì—¬ê¸°ì— docker-compose down $TARGET_COMPOSE_FILE
              exit 1
            fi
            
            # --- 5. Nginx 'API' íŠ¸ë˜í”½ ì „í™˜ ---
            echo "Switching Nginx traffic to $TARGET_API_PORT..."
            echo "server 127.0.0.1:$TARGET_API_PORT;" > $NGINX_CONF_PATH/conf.d/api_gateway_upstream.conf
            
            # --- 6. Nginx ì„¤ì • ë¦¬ë¡œë“œ (ì¤‘ë‹¨ ì—†ìŒ) ---
            # (ec2-userê°€ 'nginx -s reload'ë¥¼ sudo ì—†ì´ ì‹¤í–‰í•  ìˆ˜ ìˆì–´ì•¼ í•©ë‹ˆë‹¤)
            sudo nginx -s reload
            
            echo "Deployment successful! API traffic now routed to $TARGET_API_PORT."
            docker image prune -f