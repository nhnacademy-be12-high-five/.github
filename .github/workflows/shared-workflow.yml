name: Common Workflow (Reusable Docker Blue/Green Deploy)

on:
  workflow_call:
    inputs:
      service-name:
        required: true
        type: string
        description: "배포할 서비스의 이미지 이름 (예: book-server)"
      deploy-path:
        required: true
        type: string
        description: "서버 내 프로젝트 경로 (예: /home/ubuntu/www/nhnbook)"

    secrets:
      DOCKER_USERNAME:
        required: true
      DOCKER_PASSWORD:
        required: true
      SSH_IP:
        required: true
      SSH_ID:
        required: true
      SSH_PW:
        required: true
      SSH_PORT:
        required: true

# 권한 설정 (Dependency Submission Action 403 오류 해결용)
permissions:
  contents: read
  dependency-graph: write

jobs:
  build-push-and-deploy:
    runs-on: ubuntu-latest
    steps:
      # 1. 코드 체크아웃
      - uses: actions/checkout@v4

      # 2. JDK 21 설정
      - name: Set up JDK 21
        uses: actions/setup-java@v4
        with:
          java-version: '21'
          distribution: 'temurin'
          cache: 'maven'

      # 3. Maven 빌드
      - name: Build with Maven
        run: mvn clean package -DskipTests

      # 4. 의존성 그래프 제출 (옵션)
      - name: Update dependency graph
        uses: advanced-security/maven-dependency-submission-action@v4

      # 5. Docker Hub 로그인
      - name: Log in to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      # 6. Docker 이미지 빌드 및 푸시
      - name: Build and push Docker image
        uses: docker/build-push-action@v5
        with:
          context: .
          push: true
          tags: ${{ secrets.DOCKER_USERNAME }}/${{ inputs.service-name }}:latest

      # 7. SSH 접속 및 Blue/Green 배포 스크립트 실행
      - name: Deploy to Server (Blue/Green)
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.SSH_IP }}
          username: ${{ secrets.SSH_ID }}
          password: ${{ secrets.SSH_PW }}
          port: ${{ secrets.SSH_PORT }}
          script: |
            # 입력받은 배포 경로 사용
            DEPLOY_PATH="${{ inputs.deploy-path }}"
            NGINX_CONF_PATH="/home/backend/be12-team5/nginx"
            
            # --- 🔵 API 포트 정의 (Gateway 포트) ---
            BLUE_API_PORT="10485"
            GREEN_API_PORT="10486"
            
            echo "🚀 ${{ inputs.service-name }} 배포를 시작합니다..."
            cd $DEPLOY_PATH
            
            # --- 1. 현재 활성 'API' 포트 확인 ---
            # nginx 설정 파일에서 현재 바라보고 있는 포트를 추출 (파일이 없으면 기본값 Blue)
            CURRENT_API_PORT=$(grep -o '[0-9]\{5\}' $NGINX_CONF_PATH/conf.d/api_gateway_upstream.conf || echo "$BLUE_API_PORT")
            
            echo "🔎 현재 활성화된 포트: $CURRENT_API_PORT"

            # --- 2. 배포할 대상(Idle) 환경 결정 ---
            if [ "$CURRENT_API_PORT" == "$BLUE_API_PORT" ]; then
              echo "✅ 배포 대상: GREEN 환경 ($GREEN_API_PORT)"
              TARGET_COMPOSE_FILE="docker-compose-green.yml"
              TARGET_API_PORT=$GREEN_API_PORT
            else
              echo "✅ 배포 대상: BLUE 환경 ($BLUE_API_PORT)"
              TARGET_COMPOSE_FILE="docker-compose-blue.yml"
              TARGET_API_PORT=$BLUE_API_PORT
            fi
            
            # --- 3. 비활성(Idle) 환경에 새 버전 배포 ---
            echo "📥 최신 이미지를 다운로드(Pull) 중입니다..."
            docker-compose -f docker-compose-infra.yml -f $TARGET_COMPOSE_FILE pull
            
            echo "🔄 컨테이너를 시작합니다..."
            # 변경된 서비스만 새로고침 (no-deps)
            docker-compose -f docker-compose-infra.yml -f $TARGET_COMPOSE_FILE up -d --no-deps
            
            # --- 4. 헬스체크 (Gateway Actuator) ---
            echo "🏥 헬스 체크 중 (URL: http://127.0.0.1:$TARGET_API_PORT/actuator/health)..."
            HEALTHY=false
            
            for i in {1..10}; do
              # HTTP 상태 코드만 가져오기 (성공 시 200)
              STATUS_CODE=$(curl -s -o /dev/null -w "%{http_code}" http://127.0.0.1:$TARGET_API_PORT/actuator/health || echo "000")
            
              if [ "$STATUS_CODE" == "200" ]; then
                echo "🎉 서비스가 정상적으로 실행되었습니다! (상태코드: 200)"
                HEALTHY=true
                break
              fi
            
              echo "⏳ 시도 $i: 아직 준비되지 않음 (상태코드: $STATUS_CODE). 5초 후 재시도..."
              sleep 5
            done

            if [ "$HEALTHY" != true ]; then
              echo "❌ 배포 실패: 서비스가 정상 상태로 전환되지 않았습니다."
              exit 1
            fi
            
            # --- 5. Nginx 트래픽 전환 (설정 파일 수정) ---
            echo "🔀 Nginx 트래픽을 $TARGET_API_PORT 포트로 전환하도록 설정 파일을 수정합니다..."
            
            # 설정 파일 덮어쓰기
            echo "server 127.0.0.1:$TARGET_API_PORT;" > $NGINX_CONF_PATH/conf.d/api_gateway_upstream.conf
            
            # --- 6. Nginx 설정 리로드 (제거됨) ---
            # sudo 권한이 없으므로 명령어 실행은 생략합니다.
            # 호스트 서버의 스케줄러가 10분 내에 변경된 설정 파일을 감지하고 적용할 것입니다.
            
            echo "⏳ 설정 파일이 수정되었습니다. 호스트 서버가 설정을 가져갈 때까지(최대 10분) 대기하면 트래픽이 전환됩니다."
            echo "✅ 배포 작업이 완료되었습니다."
            
            # --- 7. 미사용 이미지 정리 ---
            docker image prune -f