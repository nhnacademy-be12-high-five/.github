# This workflow will build a Java project with Maven, and cache/restore any dependencies to improve the workflow execution time
# For more information see: https://docs.github.com/en/actions/automating-builds-and-tests/building-and-testing-java-with-maven

# This workflow uses actions that are not certified by GitHub.
# They are provided by a third-party and are governed by
# separate terms of service, privacy policy, and support
# documentation.

# ê³µí†µ ë ˆí¬ì§€í† ë¦¬
name: Common Workflow

on:
  workflow_call:
    inputs:
      service-name:
        required: true
        type: string
      deploy-path:
        required: true
        type: string

    secrets:
      DOCKER_USERNAME:
        required: true
      DOCKER_PASSWORD:
        required: true
      SSH_IP:
        required: true
      SSH_ID:
        required: true
      SSH_PW:
        required: true
      SSH_PORT:
        required: true

jobs:
  build-push-and-deploy:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up JDK 21
        uses: actions/setup-java@v4
        with:
          java-version: '21'
          distribution: 'temurin'
          cache: 'maven'

      - name: Build with Maven
        run: mvn clean package

      - name: Log in to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      - name: Build and push Docker image
        uses: docker/build-push-action@v5
        with:
          context: .
          push: true
          tags: ${{ secrets.DOCKER_USERNAME }}/${{ inputs.service-name }}:latest
            
            # ... (Common Workflowì˜ script: ë¶€ë¶„) ...
                  - name: Deploy to EC2 via SSH
                  uses: appleboy/ssh-action@master
                  with:
                    host: ${{ secrets.SSH_IP }}
                    username: ${{ secrets.SSH_ID }}
                    password: ${{ secrets.SSH_PW }}
                    port: ${{ secrets.SSH_PORT }}
                    script: |
                      DEPLOY_PATH="~/www/nhnbook"
                      NGINX_CONF_PATH="/home/backend/be12-team5/nginx"
                      
                      # --- ğŸ”µ API í¬íŠ¸ ì •ì˜ (ìš”ì²­ëŒ€ë¡œ ìˆ˜ì •) ---
                      BLUE_API_PORT="10485"
                      GREEN_API_PORT="10486"
                      
                      cd $DEPLOY_PATH
                      
                      # --- 1. í˜„ì¬ í™œì„± 'API' í¬íŠ¸ í™•ì¸ ---
                      CURRENT_API_PORT=$(grep -o '[0-9]\{5\}' $NGINX_CONF_PATH/conf.d/api_gateway_upstream.conf)
                      
                      # --- 2. ë°°í¬í•  ëŒ€ìƒ(Idle) í™˜ê²½ ê²°ì • ---
                      if [ "$CURRENT_API_PORT" == "$BLUE_API_PORT" ]; then
                        echo "Current API is BLUE ($BLUE_API_PORT). Deploying to GREEN ($GREEN_API_PORT)..."
                        TARGET_COMPOSE_FILE="docker-compose-green.yml"
                        TARGET_API_PORT=$GREEN_API_PORT
                      else
                        echo "Current API is GREEN ($GREEN_API_PORT). Deploying to BLUE ($BLUE_API_PORT)..."
                        TARGET_COMPOSE_FILE="docker-compose-blue.yml"
                        TARGET_API_PORT=$BLUE_API_PORT
                      fi
                      
                      # --- 3. ë¹„í™œì„±(Idle) í™˜ê²½ì— ìƒˆ ë²„ì „ ë°°í¬ ---
                      docker-compose -f docker-compose-infra.yml -f $TARGET_COMPOSE_FILE pull ${{ inputs.service-name }}
                      docker-compose -f docker-compose-infra.yml -f $TARGET_COMPOSE_FILE up -d --no-deps ${{ inputs.service-name }}
                      
                      # --- 4. í—¬ìŠ¤ì²´í¬ (ê°„ë‹¨íˆ sleep) ---
                      echo "Waiting for 30 seconds for service to start..."
                      sleep 30 
                      
                      # --- 5. Nginx 'API' íŠ¸ë˜í”½ ì „í™˜ ---
                      echo "Switching Nginx traffic to $TARGET_API_PORT..."
                      echo "server 127.0.0.1:$TARGET_API_PORT;" > $NGINX_CONF_PATH/conf.d/api_gateway_upstream.conf
                      
                      # ğŸš¨ front_upstream.conf ê´€ë ¨ ì½”ë“œë¥¼ ë°˜ë“œì‹œ ì‚­ì œí•´ì•¼ í•©ë‹ˆë‹¤.
                      
                      # --- 6. Nginx ì„¤ì • ë¦¬ë¡œë“œ (ì¤‘ë‹¨ ì—†ìŒ) ---
                      sudo nginx -s reload
                      
                      echo "Deployment successful! API traffic now routed to $TARGET_API_PORT."
                      docker image prune -f
            
          
            
