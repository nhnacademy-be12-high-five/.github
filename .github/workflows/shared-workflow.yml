name: Common Workflow (Reusable Docker Rolling Deploy)

on:
  workflow_call:
    inputs:
      service-name:
        required: true
        type: string
        description: "ë°°í¬í•  ì„œë¹„ìŠ¤ì˜ ì´ë¯¸ì§€ ì´ë¦„ (ì˜ˆ: book-server ë˜ëŠ” front_server)"
      deploy-path:
        required: true
        type: string
        description: "ì„œë²„ ë‚´ í”„ë¡œì íŠ¸ ê²½ë¡œ (ì˜ˆ: /home/ubuntu/www/nhnbook)"

    secrets:
      DOCKER_USERNAME:
        required: true
      DOCKER_PASSWORD:
        required: true
      SSH_IP:
        required: true
      SSH_ID:
        required: true
      SSH_PW:
        required: true
      SSH_PORT:
        required: true

jobs:
  build-push-and-deploy:
    runs-on: ubuntu-latest
    steps:
      # 1. ì½”ë“œ ì²´í¬ì•„ì›ƒ
      - uses: actions/checkout@v4

      # 2. JDK 21 ì„¤ì •
      - name: Set up JDK 21
        uses: actions/setup-java@v4
        with:
          java-version: '21'
          distribution: 'temurin'
          cache: 'maven'

      # 3. Maven ë¹Œë“œ
      - name: Build with Maven
        run: mvn clean package -DskipTests

      # 4. Docker Hub ë¡œê·¸ì¸
      - name: Log in to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      # 5. Docker ì´ë¯¸ì§€ ë¹Œë“œ ë° í‘¸ì‹œ
      - name: Build and push Docker image
        uses: docker/build-push-action@v5
        with:
          context: .
          push: true
          tags: ${{ secrets.DOCKER_USERNAME }}/${{ inputs.service-name }}:latest

      # 6. SSH ì ‘ì† ë° ë¡¤ë§ ë°°í¬
      - name: Deploy to Server (Rolling)
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.SSH_IP }}
          username: ${{ secrets.SSH_ID }}
          password: ${{ secrets.SSH_PW }}
          port: ${{ secrets.SSH_PORT }}
          script: |
            DEPLOY_PATH="${{ inputs.deploy-path }}"
            SERVICE_NAME="${{ inputs.service-name }}"
            echo "ğŸš€ $SERVICE_NAME ë°°í¬ë¥¼ ì‹œì‘í•©ë‹ˆë‹¤..."
            cd $DEPLOY_PATH

            # ì„œë¹„ìŠ¤ë³„ ê³ ì • í¬íŠ¸
            case "$SERVICE_NAME" in
              front_server)
                PORT=10483
                HEALTH_PATH=""
                ;;
              gateway_server)
                PORT=10485
                HEALTH_PATH="/actuator/health"
                ;;
              member_server)
                PORT=10487
                HEALTH_PATH="/actuator/health"
                ;;
              book_server)
                PORT=10489
                HEALTH_PATH="/actuator/health"
                ;;
              order_server)
                PORT=10491
                HEALTH_PATH="/actuator/health"
                ;;
              payment_server)
                PORT=10493
                HEALTH_PATH="/actuator/health"
                ;;
              coupon_server)
                PORT=10495
                HEALTH_PATH="/actuator/health"
                ;;
              *)
                echo "âŒ ì•Œ ìˆ˜ ì—†ëŠ” ì„œë¹„ìŠ¤: $SERVICE_NAME"
                exit 1
                ;;
            esac

            echo "ğŸ“¥ ìµœì‹  ì´ë¯¸ì§€ ë‹¤ìš´ë¡œë“œ ì¤‘..."
            docker-compose -f docker-compose-infra.yml -f docker-compose.yml pull $SERVICE_NAME

            echo "ğŸ”„ ìƒˆ ì»¨í…Œì´ë„ˆ ì‹œì‘..."
            docker-compose -f docker-compose-infra.yml -f docker-compose.yml up -d --no-deps $SERVICE_NAME

            # í—¬ìŠ¤ì²´í¬
            HEALTH_URL="http://127.0.0.1:$PORT$HEALTH_PATH"
            echo "ğŸ¥ í—¬ìŠ¤ ì²´í¬ ì¤‘: $HEALTH_URL"
            HEALTHY=false
            for i in {1..10}; do
              STATUS_CODE=$(curl -s -o /dev/null -w "%{http_code}" $HEALTH_URL || echo "000")
              if [ "$STATUS_CODE" == "200" ]; then
                echo "ğŸ‰ $SERVICE_NAME ì •ìƒ ì‹¤í–‰!"
                HEALTHY=true
                break
              fi
              echo "â³ ì‹œë„ $i: ì¤€ë¹„ë˜ì§€ ì•ŠìŒ ($STATUS_CODE), 5ì´ˆ ëŒ€ê¸°..."
              sleep 5
            done

            if [ "$HEALTHY" != true ]; then
              echo "âŒ ë°°í¬ ì‹¤íŒ¨: ì„œë¹„ìŠ¤ê°€ ì •ìƒ ìƒíƒœë¡œ ì „í™˜ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤."
              docker stop team5-${SERVICE_NAME} || true
              docker rm team5-${SERVICE_NAME} || true
              exit 1
            fi

            # ê¸°ì¡´ ì»¨í…Œì´ë„ˆ ì¢…ë£Œ
            echo "ğŸ—‘ï¸ ê¸°ì¡´ ì»¨í…Œì´ë„ˆ ì¢…ë£Œ ë° ì œê±°..."
            docker ps -a --filter "name=team5-${SERVICE_NAME}" --format "{{.ID}}" | xargs -r docker stop
            docker ps -a --filter "name=team5-${SERVICE_NAME}" --format "{{.ID}}" | xargs -r docker rm

            echo "âœ… ë°°í¬ ì™„ë£Œ!"
            docker image prune -f
