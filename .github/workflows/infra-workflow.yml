name: Infra ê³µìš© ë°°í¬

on:
  workflow_call:
    inputs:
      service-name:
        required: true
        type: string
        description: "docker-compose.ymlì— ì •ì˜ëœ ê¸°ë³¸ ì„œë¹„ìŠ¤ ì´ë¦„ (ì˜ˆ: front_server, eureka_server)"
      # [ì¶”ê°€ë¨] ë‹¤ì¤‘ ì¸ìŠ¤í„´ìŠ¤(_1, _2)ë¡œ ë°°í¬ë˜ëŠ” ì„œë¹„ìŠ¤ì¸ì§€ ì—¬ë¶€
      is-multi-instance:
        required: false
        type: boolean
        default: false
        description: "trueì¼ ê²½ìš° _1, _2ë¥¼ ë¶™ì—¬ì„œ ìˆœì°¨ ë°°í¬í•©ë‹ˆë‹¤. (ê¸°ë³¸ê°’: false)"
      container-name:
        required: false # í•„ìˆ˜ì—ì„œ ì„ íƒìœ¼ë¡œ ë³€ê²½ (ë” ì´ìƒ ìŠ¤í¬ë¦½íŠ¸ì—ì„œ ì‚¬ìš© ì•ˆ í•¨)
        type: string
        description: "(ì‚¬ìš©ë˜ì§€ ì•ŠìŒ) ì´ì „ ë²„ì „ í˜¸í™˜ì„±ì„ ìœ„í•´ ìœ ì§€"
      compose-file:
        required: false
        type: string
        default: "docker-compose.yml"
        description: "ì‚¬ìš©í•  docker-compose íŒŒì¼ëª…"

    secrets:
      DOCKER_USERNAME:
        required: true
      DOCKER_PASSWORD:
        required: true
      SSH_IP:
        required: true
      SSH_ID:
        required: true
      SSH_PW:
        required: true
      SSH_PORT:
        required: true

jobs:
  deploy-infra:
    runs-on: ubuntu-latest

    steps:
      - name: ì½”ë“œ ì²´í¬ì•„ì›ƒ
        uses: actions/checkout@v4

      - name: JDK 21 ì„¤ì •
        uses: actions/setup-java@v4
        with:
          java-version: '21'
          distribution: 'temurin'
          cache: maven

      # ì¸í”„ë¼ ì„œë¹„ìŠ¤ëŠ” í…ŒìŠ¤íŠ¸ ì—†ì´ ë¹Œë“œë§Œ ìˆ˜í–‰
      - name: Maven ë¹Œë“œ
        run: mvn clean package -DskipTests

      - name: Docker ë¡œê·¸ì¸
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      - name: Docker ì´ë¯¸ì§€ ë¹Œë“œ ë° í‘¸ì‹œ
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./Dockerfile
          push: true
          # ì´ë¯¸ì§€ íƒœê·¸ëŠ” ì…ë ¥ë°›ì€ service-nameì„ ì‚¬ìš©
          tags: ${{ secrets.DOCKER_USERNAME }}/${{ inputs.service-name }}:latest

      - name: ì„œë²„ì— ë°°í¬
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.SSH_IP }}
          username: ${{ secrets.SSH_ID }}
          password: ${{ secrets.SSH_PW }}
          port: ${{ secrets.SSH_PORT }}
          script: |
            echo "ğŸš€ ${{ inputs.service-name }} ë°°í¬ ì‹œì‘..."
            cd ~/www/nhnbook

            SERVICE_NAME="${{ inputs.service-name }}"
            COMPOSE_FILE="${{ inputs.compose-file }}"
            IS_MULTI_INSTANCE="${{ inputs.is-multi-instance }}"

            # --- [í•µì‹¬ ìˆ˜ì •] ë°°í¬ ë¡œì§ ë¶„ê¸° ---
            if [ "$IS_MULTI_INSTANCE" = "true" ]; then
              # === ë‹¤ì¤‘ ì¸ìŠ¤í„´ìŠ¤ ë°°í¬ (ì˜ˆ: front_server, book_server ë“±) ===
              echo "â„¹ï¸ ë‹¤ì¤‘ ì¸ìŠ¤í„´ìŠ¤(_1, _2) ë°°í¬ ëª¨ë“œë¡œ ì‹¤í–‰í•©ë‹ˆë‹¤."
            
              for i in 1 2; do
                TARGET_SERVICE="${SERVICE_NAME}_${i}"
                echo "ğŸ”„ $TARGET_SERVICE ë°°í¬ ì§„í–‰ ì¤‘..."
            
                # ê¸°ì¡´ ì»¨í…Œì´ë„ˆë¥¼ ë‚´ë¦¬ê³  ì´ë¯¸ì§€ë¥¼ ì‚­ì œí•˜ëŠ” ê³¼ì •ì€
                # docker compose up -dê°€ ì•Œì•„ì„œ ì²˜ë¦¬í•˜ë¯€ë¡œ ìƒëµí•´ë„ ë©ë‹ˆë‹¤.
                # ëª…ì‹œì ìœ¼ë¡œ í•˜ê³  ì‹¶ë‹¤ë©´ ì•„ë˜ ì£¼ì„ì„ í•´ì œí•˜ì„¸ìš”.
                # docker compose -f $COMPOSE_FILE stop $TARGET_SERVICE || true
                # docker compose -f $COMPOSE_FILE rm -f $TARGET_SERVICE || true

                docker compose -f $COMPOSE_FILE pull $TARGET_SERVICE
                docker compose -f $COMPOSE_FILE up -d $TARGET_SERVICE
            
                # ë¡¤ë§ ë°°í¬ë¥¼ ìœ„í•´ ì¸ìŠ¤í„´ìŠ¤ ê°„ ëŒ€ê¸° ì‹œê°„ ë¶€ì—¬
                echo "â³ ì•ˆì •í™”ë¥¼ ìœ„í•´ 10ì´ˆ ëŒ€ê¸°..."
                sleep 10
              done
            else
              # === ë‹¨ì¼ ì¸ìŠ¤í„´ìŠ¤ ë°°í¬ (ì˜ˆ: eureka_server, gateway_server ë“±) ===
              echo "â„¹ï¸ ë‹¨ì¼ ì¸ìŠ¤í„´ìŠ¤ ë°°í¬ ëª¨ë“œë¡œ ì‹¤í–‰í•©ë‹ˆë‹¤."

              # docker compose -f $COMPOSE_FILE stop $SERVICE_NAME || true
              # docker compose -f $COMPOSE_FILE rm -f $SERVICE_NAME || true
            
              docker compose -f $COMPOSE_FILE pull $SERVICE_NAME
              docker compose -f $COMPOSE_FILE up -d $SERVICE_NAME
            fi
            # ------------------------------------

            # í—¬ìŠ¤ ì²´í¬ í¬íŠ¸ ì„¤ì •
            PORT=8080 # ê¸°ë³¸ê°’ (í”„ë¡ íŠ¸ ì„œë²„ ë“± actuator ì—†ëŠ” ê²½ìš° ëŒ€ë¹„)
            case "$SERVICE_NAME" in
              "eureka_server") PORT=10481 ;;
              "config_server") PORT=10482 ;;
              "gateway-server") PORT=10485 ;;
              "front-server") PORT=10483 ;; # í”„ë¡ íŠ¸ ì„œë²„ 1ë²ˆ í¬íŠ¸ ê¸°ì¤€
            esac

            echo "ğŸ¥ í—¬ìŠ¤ ì²´í¬ ì‹œì‘ (Target Port: $PORT)..."
            HEALTHY=false
            
            # ìµœëŒ€ 15ë²ˆ ì‹œë„ (75ì´ˆ ëŒ€ê¸°)
            for i in {1..15}; do
              # Actuatorê°€ ì—†ëŠ” ì„œë¹„ìŠ¤(ì˜ˆ: í”„ë¡ íŠ¸)ë¥¼ ìœ„í•´ ë£¨íŠ¸ ê²½ë¡œ(/)ë¡œ ì²´í¬í•˜ê±°ë‚˜
              # íŠ¹ì • í—¬ìŠ¤ì²´í¬ ì—”ë“œí¬ì¸íŠ¸ë¥¼ ì‚¬ìš©í•˜ë„ë¡ ìˆ˜ì •ì´ í•„ìš”í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
              # ì—¬ê¸°ì„œëŠ” ì¼ë‹¨ ê¸°ì¡´ ë¡œì§ì„ ìœ ì§€í•©ë‹ˆë‹¤.
              STATUS=$(curl -s -o /dev/null -w "%{http_code}" http://127.0.0.1:$PORT/actuator/health || echo "000")
            
              # í”„ë¡ íŠ¸ ì„œë²„ì²˜ëŸ¼ actuatorê°€ ì—†ëŠ” ê²½ìš° 200 OKê°€ ì•„ë‹Œ 404 ë“±ì´ ë‚˜ì˜¬ ìˆ˜ ìˆìŒ
              # ì´ ê²½ìš° í¬íŠ¸ê°€ ì—´ë ¤ìˆëŠ”ì§€ í™•ì¸í•˜ëŠ” ë°©ì‹ ë“±ìœ¼ë¡œ ë³€ê²½ í•„ìš” (nc -z ë“± ì‚¬ìš©)
              if [ "$STATUS" == "200" ] || ([ "$SERVICE_NAME" == "front_server" ] && [ "$STATUS" != "000" ]); then
                HEALTHY=true
                echo "âœ… [$i/15] ìƒíƒœ ì •ìƒ (ì‘ë‹µì½”ë“œ: $STATUS)"
                break
              fi
              echo "â³ [$i/15] ëŒ€ê¸° ì¤‘... (ì‘ë‹µì½”ë“œ: $STATUS)"
              sleep 5
            done

            if [ "$HEALTHY" != true ]; then
              echo "âŒ ë°°í¬ ì‹¤íŒ¨: í—¬ìŠ¤ ì²´í¬ íƒ€ì„ì•„ì›ƒ"
              # ë‹¤ì¤‘ ì¸ìŠ¤í„´ìŠ¤ì¼ ê²½ìš° ë¡œê·¸ í™•ì¸ì´ ë³µì¡í•´ì§ˆ ìˆ˜ ìˆìŒ
              # echo "ğŸ“‹ ìµœê·¼ ë¡œê·¸ ì¶œë ¥:"
              # docker logs --tail 50 ...
              exit 1
            fi

            docker image prune -f
            echo "ğŸ‰ ${{ inputs.service-name }} ë°°í¬ ì™„ë£Œ!"