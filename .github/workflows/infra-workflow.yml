name: Infra ê³µìš© ë°°í¬

on:
  workflow_call:
    inputs:
      service-name:
        required: true
        type: string
        description: "docker-compose.ymlì— ì •ì˜ëœ ê¸°ë³¸ ì„œë¹„ìŠ¤ ì´ë¦„ (ì˜ˆ: front_server, eureka_server)"
      # [ì¶”ê°€ë¨] ë‹¤ì¤‘ ì¸ìŠ¤í„´ìŠ¤(_1, _2)ë¡œ ë°°í¬ë˜ëŠ” ì„œë¹„ìŠ¤ì¸ì§€ ì—¬ë¶€
      is-multi-instance:
        required: false
        type: boolean
        default: false
        description: "trueì¼ ê²½ìš° _1, _2ë¥¼ ë¶™ì—¬ì„œ ìˆœì°¨ ë°°í¬í•©ë‹ˆë‹¤. (ê¸°ë³¸ê°’: false)"
      container-name:
        required: false # í•„ìˆ˜ì—ì„œ ì„ íƒìœ¼ë¡œ ë³€ê²½ (ë” ì´ìƒ ìŠ¤í¬ë¦½íŠ¸ì—ì„œ ì‚¬ìš© ì•ˆ í•¨)
        type: string
        description: "(ì‚¬ìš©ë˜ì§€ ì•ŠìŒ) ì´ì „ ë²„ì „ í˜¸í™˜ì„±ì„ ìœ„í•´ ìœ ì§€"
      compose-file:
        required: false
        type: string
        default: "docker-compose.yml"
        description: "ì‚¬ìš©í•  docker-compose íŒŒì¼ëª…"

    secrets:
      DOCKER_USERNAME:
        required: true
      DOCKER_PASSWORD:
        required: true
      SSH_IP:
        required: true
      SSH_ID:
        required: true
      SSH_PW:
        required: true
      SSH_PORT:
        required: true

jobs:
  deploy-infra:
    runs-on: ubuntu-latest

    steps:
      - name: ì½”ë“œ ì²´í¬ì•„ì›ƒ
        uses: actions/checkout@v4

      - name: JDK 21 ì„¤ì •
        uses: actions/setup-java@v4
        with:
          java-version: '21'
          distribution: 'temurin'
          cache: maven

      # ì¸í”„ë¼ ì„œë¹„ìŠ¤ëŠ” í…ŒìŠ¤íŠ¸ ì—†ì´ ë¹Œë“œë§Œ ìˆ˜í–‰
      - name: Maven ë¹Œë“œ
        run: mvn clean package -DskipTests

      - name: Docker ë¡œê·¸ì¸
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      - name: Docker ì´ë¯¸ì§€ ë¹Œë“œ ë° í‘¸ì‹œ
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./Dockerfile
          push: true
          # ì´ë¯¸ì§€ íƒœê·¸ëŠ” ì…ë ¥ë°›ì€ service-nameì„ ì‚¬ìš©
          tags: ${{ secrets.DOCKER_USERNAME }}/${{ inputs.service-name }}:latest

      - name: ì„œë²„ì— ë°°í¬
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.SSH_IP }}
          username: ${{ secrets.SSH_ID }}
          password: ${{ secrets.SSH_PW }}
          port: ${{ secrets.SSH_PORT }}
          script: |
            echo "ğŸš€ ${{ inputs.service-name }} ë°°í¬ ì‹œì‘..."
            cd ~/www/nhnbook
            
            # 1. ì…ë ¥ ë³€ìˆ˜ ì •ë¦¬
            # INPUT_NAME: ì›Œí¬í”Œë¡œìš°ì—ì„œ ë„˜ê²¨ë°›ì€ ì´ë¦„ (ì˜ˆ: team5-gateway-server)
            INPUT_NAME="${{ inputs.service-name }}"
            COMPOSE_FILE="${{ inputs.compose-file }}"
            IS_MULTI_INSTANCE="${{ inputs.is-multi-instance }}"
            
            # 2. Docker Composeìš© ì„œë¹„ìŠ¤ ì´ë¦„ ì¶”ì¶œ (team5- ì ‘ë‘ì‚¬ ì œê±°)
            # ì˜ˆ: team5-gateway-server -> gateway-server
            # ì˜ˆ: team5-front-server   -> front-server
            SERVICE_KEY=${INPUT_NAME#team5-}
            
            echo "â„¹ï¸ ì…ë ¥ ì´ë¦„: $INPUT_NAME"
            echo "â„¹ï¸ Compose ì„œë¹„ìŠ¤ í‚¤: $SERVICE_KEY"
            
            # -----------------------------------------------------------
            # 3. ë°°í¬ ì‹¤í–‰ (Compose ì„œë¹„ìŠ¤ í‚¤ ì‚¬ìš©)
            # -----------------------------------------------------------
            if [ "$IS_MULTI_INSTANCE" = "true" ]; then
              echo "â„¹ï¸ ë‹¤ì¤‘ ì¸ìŠ¤í„´ìŠ¤ ë°°í¬ ëª¨ë“œ (Front)"
              for i in 1 2; do
                # team5-front-server -> front-server-1, front-server-2
                TARGET="${SERVICE_KEY}-${i}"
            
                echo "ğŸ”„ $TARGET ë°°í¬ ì¤‘..."
                docker compose -f $COMPOSE_FILE pull $TARGET
                docker compose -f $COMPOSE_FILE up -d $TARGET
                sleep 10
              done
            else
              echo "â„¹ï¸ ë‹¨ì¼ ì¸ìŠ¤í„´ìŠ¤ ë°°í¬ ëª¨ë“œ"
              # team5-gateway-server -> gateway-server ë¡œ ëª…ë ¹ ì‹¤í–‰
              docker compose -f $COMPOSE_FILE pull $SERVICE_KEY
              docker compose -f $COMPOSE_FILE up -d $SERVICE_KEY
            fi
            
            # -----------------------------------------------------------
            # 4. í—¬ìŠ¤ ì²´í¬ í¬íŠ¸ ì„¤ì • (ì…ë ¥ ì´ë¦„ ê¸°ì¤€)
            # -----------------------------------------------------------
            CHECK_PORT=8080
            
            # team5- ê°€ ë¶™ì–´ìˆë“  ì•ˆ ë¶™ì–´ìˆë“  ëª¨ë‘ ì²˜ë¦¬í•˜ë„ë¡ ìˆ˜ì •
            case "$INPUT_NAME" in
              *"eureka-server"*)  CHECK_PORT=10481 ;;
              *"config-server"*)  CHECK_PORT=10482 ;;
              *"gateway-server"*) CHECK_PORT=10485 ;; # ì™¸ë¶€ í¬íŠ¸
              *"front-server"*)   CHECK_PORT=10483 ;;
            esac
            
            echo "ğŸ¥ í—¬ìŠ¤ ì²´í¬ ì‹œì‘ (Target: $INPUT_NAME, Host Port: $CHECK_PORT)..."
            HEALTHY=false
            
            for i in {1..15}; do
              # Hostì—ì„œ curl ìš”ì²­
              STATUS=$(curl -s -o /dev/null -w "%{http_code}" http://127.0.0.1:$CHECK_PORT/actuator/health || echo "000")
            
              # 000(ì—°ê²°ì‹¤íŒ¨)ë§Œ ì•„ë‹ˆë©´ ì„œë²„ê°€ ëœ¬ ê²ƒìœ¼ë¡œ ê°„ì£¼ (404, 401 í¬í•¨)
              if [ "$STATUS" != "000" ]; then
                HEALTHY=true
                if [ "$STATUS" == "200" ]; then
                    echo "âœ… [$i/15] ìƒíƒœ ì •ìƒ (Code: 200)"
                else
                    echo "âš ï¸ [$i/15] ì„œë²„ ìƒì¡´ í™•ì¸ë¨ (Code: $STATUS) - Actuator ê²½ë¡œ í™•ì¸ í•„ìš”"
                fi
                break
              fi
            
              echo "â³ [$i/15] ë¶€íŒ… ëŒ€ê¸° ì¤‘... (Code: $STATUS)"
              sleep 5
            done
            
            if [ "$HEALTHY" != true ]; then
              echo "âŒ ë°°í¬ ì‹¤íŒ¨: ì„œë²„ ì—°ê²° ë¶ˆê°€ (íƒ€ì„ì•„ì›ƒ)"
              echo "ğŸ“‹ ë¡œê·¸ í™•ì¸:"
            
              # ë¡œê·¸ í™•ì¸ ì‹œì—ëŠ” ì»¨í…Œì´ë„ˆ ì´ë¦„(team5-...)ì„ ì‚¬ìš©í•´ì•¼ í•¨
              # ì…ë ¥ê°’ ìì²´ê°€ team5-gateway-serverë¼ë©´ ê·¸ëŒ€ë¡œ ì‚¬ìš©
              # ë§Œì•½ ì•„ë‹ˆë¼ë©´ team5-ë¥¼ ë¶™ì—¬ì¤Œ
              if [[ "$INPUT_NAME" == "team5-"* ]]; then
                  LOG_TARGET="$INPUT_NAME"
              else
                  LOG_TARGET="team5-$INPUT_NAME"
              fi
            
              if [ "$IS_MULTI_INSTANCE" = "true" ]; then
                 docker logs --tail 50 "${LOG_TARGET}-1"
              else
                 docker logs --tail 50 "${LOG_TARGET}"
              fi
              exit 1
            fi
            
            docker image prune -f
            echo "ğŸ‰ $INPUT_NAME ë°°í¬ ì™„ë£Œ!"